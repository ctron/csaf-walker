name: CI

on:
  push:
    # Run on the main branch
    branches:
      - main
      - release/*
  # Also on PRs, just be careful not to publish anything
  pull_request:
  # Allow to be called from other workflows (like "release")
  workflow_call:
  # But don't trigger on tags, as they are covered by the "release.yaml" workflow

jobs:

  common:
    uses: scm-rs/shared-workflows/.github/workflows/ci.yaml@main
    with:
      preflight_install: |
        sudo apt install clang llvm pkg-config nettle-dev
      preflight_semver_exclude: csaf-cli,sbom-cli,walker-extras # drop walker-extras later
      preflight_semver_feature_group: default-features
      preflight_semver_features: _semver
      matrix_include: |
        [
          {
            "os": "ubuntu-22.04",
            "install": "sudo apt install clang llvm pkg-config nettle-dev"
          },
          {
            "os": "windows-2022",
            "install": "pacman -S mingw-w64-x86_64-{clang,pkg-config,nettle} libnettle-devel",
            "args": "--features crypto-cng --no-default-features",
          },
          {
            "os": "macos-14",
          }
        ]

  ci:
    runs-on: ubuntu-latest
    needs:
      - common
    if: always()
    steps:
      - name: Success
        if: ${{ !(contains(needs.*.result, 'failure')) }}
        run: exit 0
      - name: Failure
        if: ${{ contains(needs.*.result, 'failure') }}
        run: exit 1
